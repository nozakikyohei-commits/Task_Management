<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" >
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>タスク表示画面</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
		<link th:href="@{/css/style.css}" rel="stylesheet">
	</head>
	
	<body>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
	
		<header th:replace="~{common/header :: header_fragment}"></header>
		
		<main>
			<!--mainタグ内で使用できる変数を設定（インナークラスまで設定する必要あり）-->
			<div class="mx-2" 
				 th:with="url=${T(com.example.demo.constant.AppConst.Url)},
				 		  importance=${T(com.example.demo.constant.AppConst.TaskImportance)},
				 		  status=${T(com.example.demo.constant.AppConst.TaskStatus)}">
			
			<h1 class="mt-4">タスク一覧</h1>
			
			<div th:replace="~{common/tabs :: task_tabs(${currentTab})}"></div>
			
			<table class="text-center table table-striped table-bordered">
				<thead>
					<tr>
						<th>タスク名</th> 
						<th>
							<!--リクエストパラメータに現在のタブ、何を基準にするか、（現在のパラメータを参照し）昇順・降順どちらにするかを持たせコントローラーに送る-->
							<a class="sort-link"
							   th:href="@{${url.VIEW_TASKS}(tab=${currentTab}, sort='deadline', order=${currentSort == 'deadline' && currentOrder == 'asc' ? 'desc' : 'asc'})}">
								期限
								<!--現在の並び方が昇順か降順かわかりやすいよう表示をしておく-->
								<span th:if="${currentSort == 'deadline'}" 
									  th:text="${currentOrder == 'asc' ? '▲' : '▼'}"></span>
							</a>
						</th>

						<th>
							<a class="sort-link"
							   th:href="@{${url.VIEW_TASKS}(tab=${currentTab}, sort='importance', order=${currentSort == 'importance' && currentOrder == 'asc' ? 'desc' : 'asc'})}">
								重要度
								<span th:if="${currentSort == 'importance'}" 
									  th:text="${currentOrder == 'asc' ? '▲' : '▼'}"></span>
							</a>
						</th>

						<th>
							<a class="sort-link"
							   th:href="@{${url.VIEW_TASKS}(tab=${currentTab}, sort='status', order=${currentSort == 'status' && currentOrder == 'asc' ? 'desc' : 'asc'})}">
								状態
								<span th:if="${currentSort == 'status'}" 
									  th:text="${currentOrder == 'asc' ? '▲' : '▼'}"></span>
							</a>
						</th>

						<th>操作</th>
            			
						<th th:if="${currentTab == 'completed'}">
							<a class="sort-link"
							   th:href="@{${url.VIEW_TASKS}(tab=${currentTab}, sort='completedDate', order=${currentSort == 'completedDate' && currentOrder == 'asc' ? 'desc' : 'asc'})}">
								完了日
								<span th:if="${currentSort == 'completedDate'}" 
									  th:text="${currentOrder == 'asc' ? '▲' : '▼'}"></span>
							</a>
						</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="task : ${tasks}">
						
						<td>
							<!--各タスクの編集画面に遷移できるよう、リクエストパラメータにタスクIDを持たせる-->
							<a th:href="@{|${url.EDIT_TASK}/${task.taskId}|}" 
							   th:text="${task.name}" 
							   class="text-decoration-none text-dark">
							</a>
						</td>
						
						<td th:text="${task.deadline}"></td>
						<td>
							<span th:if="${task.importance == importance.UNSET}">指定なし</span>
							<span th:if="${task.importance == importance.LOW}">低</span>
							<span th:if="${task.importance == importance.MEDIUM}">中</span>
							<span th:if="${task.importance == importance.HIGH}">高</span>
						</td>
						<td>
							<span th:if="${task.status == status.INCOMPLETE}" class="badge bg-success">未完了</span>
			                <span th:if="${task.status == status.COMPLETED}" class="badge bg-success">期限内完了</span>
			                <span th:if="${task.status == status.EXPIRED}" class="badge bg-danger">期限切れ</span>
			                <span th:if="${task.status == status.EXPIRED_COMPLETED}" class="badge bg-warning text-dark">期限切れ完了</span>
			            </td>
						<td>
							<!--現在のタブを参照してボタンの表示、送るURLを変更する-->
							<span th:if="${currentTab == 'incomplete'}">
								<form th:action="@{|${url.VIEW_TASKS}/${task.taskId}/complete|}" method="post">
									<button class="btn btn-primary" type="submit">完了</button>
								</form>
							</span>
							
							<span th:if="${currentTab == 'completed'}">
								<form th:action="@{|${url.VIEW_TASKS}/${task.taskId}/incomplete|}" method="post">
									<button class="btn btn-secondary" type="submit">未完了に戻す</button>
								</form>
							</span>
						</td>
						<td th:if="${currentTab == 'completed'}" th:text="${task.completedDate}"></td>
						
					</tr>
				</tbody>
			</table>
			</div>
		</main>
	</body>
</html>