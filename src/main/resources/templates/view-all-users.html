<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" >
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>ユーザー管理画面</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
		<link th:href="@{/css/style.css}" rel="stylesheet">
	</head>
	
	<body>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
		
		<header th:replace="~{common/header :: header_fragment}"></header>
		
		<main>
			
			<div class="mx-2" 
				 th:with="url=${T(com.example.demo.constant.AppConst.Url)},
				 		  role=${T(com.example.demo.constant.AppConst.UserRole)}">
			
				<h1 class="mt-4">ユーザー管理画面</h1>
				
				<div th:if="${errorMessage}" class="alert alert-danger" role="alert">
			        <span th:text="${errorMessage}"></span>
			    </div>
				
				<table class="text-center table table-striped table-bordered">
					<thead>
						<tr>
							<th class="bg-primary-subtle">
								<a class="sort-link"
								   th:href="@{${url.VIEW_ALL_USERS}(sort='userId', order=${currentSort == 'userId' && currentOrder == 'asc' ? 'desc' : 'asc'})}">
									ユーザーID
								<span th:if="${currentSort == 'userId'}" 
									  th:text="${currentOrder == 'asc' ? '▲' : '▼'}"></span>
								</a>
							</th>
							<th class="bg-primary-subtle">ユーザー名</th>
							<th class="bg-primary-subtle">メールアドレス</th>
							<th class="bg-primary-subtle">
								<a class="sort-link"
								   th:href="@{${url.VIEW_ALL_USERS}(sort='role', order=${currentSort == 'role' && currentOrder == 'asc' ? 'desc' : 'asc'})}">
									権限
								<span th:if="${currentSort == 'role'}" 
									  th:text="${currentOrder == 'asc' ? '▲' : '▼'}"></span>
								</a>
							</th>
							<th class="bg-primary-subtle">登録日時</th>
							<th class="bg-primary-subtle">更新日時</th>
							<th class="bg-primary-subtle">操作</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="oneUser : ${users}">
							
							<td>
								<a th:href="@{|${url.EDIT_USER}/${oneUser.userId}|}" 
								   th:text="${oneUser.userId}" 
								   class="sort-link">
								</a>
							</td>
							
							<td th:text="${oneUser.name}"></td>
							
							<td th:text="${oneUser.mailAddress}"></td>
							
							<td>
								<span th:if="${oneUser.role == role.GENERAL}">一般</span>
								<span th:if="${oneUser.role == role.ADMIN}">管理者</span>
							</td>
							
							<td th:text="${#temporals.format(oneUser.createdAt, 'yyyy/MM/dd HH:mm')}"></td>
							
							<td th:text="${#temporals.format(oneUser.updatedAt, 'yyyy/MM/dd HH:mm')}"></td>
							
							<td>
								<!--th:blockを使っておけば処理後にth:blockというタグ自体は消えてくれるためレイアウトをきれいに保てる
									ログインユーザー以外にはモーダルにつながるボタンを表示-->
								<th:block th:if="${oneUser.userId != user.userId}">
							    <button type="button" class="btn btn-danger" 
							            data-bs-toggle="modal" 
							            th:data-bs-target="|#deleteModal-${oneUser.userId}|">
							        削除
							    </button>
							    
							    <!--モーダルID内にユーザーIDを入れなければ、すべて同じモーダルを開くためのボタンだと認識される
							    	→どの削除ボタンを押しても作成されるURLが"/view-all-users/1/delete"になってしまう-->
							    <div class="modal fade" th:id="|deleteModal-${oneUser.userId}|" tabindex="-1">
							        <div class="modal-dialog">
							            <div class="modal-content">
							                <div class="modal-header">
							                    <h5 class="modal-title">削除確認</h5>
							                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
							                </div>
							                <div class="modal-body">
												<!--区別がつきやすいようにspanでユーザー名を入れておく-->
							                    <span class="fw-bold" th:text="${oneUser.name}"></span>
							                    さんを本当に削除してもよろしいですか？<br>
							                    この操作は取り消せません。
							                </div>
							                <div class="modal-footer">
							                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
							                    
							                    <form th:action="@{|${url.VIEW_ALL_USERS}/${oneUser.userId}/delete|}" method="post">
							                        <button type="submit" class="btn btn-danger">削除する</button>
							                    </form>
							                    
							                </div>
							            </div>
							        </div>
							    </div>
								</th:block>
								
								<!--ログインユーザーの欄にはボタンを表示させず、ビュー側からの削除リクエスト送信を防ぐ-->
								<span th:if="${oneUser.userId == user.userId}" class="text-secondary fw-bold">ログイン中</span>
							</td>
							
						</tr>
						
					</tbody>
				</table>
				
				
			
			</div>
			
		</main>
	</body>
</html>